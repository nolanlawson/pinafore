<div class="virtual-list-item list-item {shown ? 'shown' : ''}"
     aria-hidden={!shown}
     ref:node
     style="transform: translateY({offset}px);" >
  <svelte:component this={component}
              virtualProps={props}
              virtualIndex={index}
              virtualLength={$length}
              virtualKey={key}
              on:recalculateHeight="doRecalculateHeight()"/>
</div>
<style>
  .virtual-list-item {
    position: absolute;
    width: 100%;
    top: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.333s linear;
    contain: content; /* see https://www.w3.org/TR/2018/CR-css-contain-1-20181108/#valdef-contain-content */
  }
  .virtual-list-item.shown {
    opacity: 1;
    pointer-events: auto;
  }
</style>
<script>
  import { virtualListStore } from './virtualListStore'
  import { registerResizeListener, unregisterResizeListener } from '../../_utils/resize'
  import { mark, stop } from '../../_utils/marks'

  export default {
    oncreate () {
      const { key } = this.get()
      const node = this.refs.node
      requestAnimationFrame(() => {
        if (!node || !key) {
          return
        }
        mark('VirtualListItem gBCR')
        const rect = node.getBoundingClientRect()
        stop('VirtualListItem gBCR')
        // update all item heights in one batch for better perf
        this.store.batchUpdateForRealm('itemHeights', key, rect.height)
      })
      this.doRecalculateHeight = this.doRecalculateHeight.bind(this)
      registerResizeListener(this.doRecalculateHeight)
    },
    ondestroy () {
      unregisterResizeListener(this.doRecalculateHeight)
    },
    store: () => virtualListStore,
    computed: {
      shown: ({ $itemHeights, key }) => $itemHeights[key] > 0
    },
    methods: {
      doRecalculateHeight () {
        // Recalculate immediately because this is done on-demand, e.g.
        // when clicking the "More" button on a spoiler.
        const rect = this.refs.node.getBoundingClientRect()
        const { key } = this.get()
        const { itemHeights } = this.store.get()
        itemHeights[key] = rect.height
        this.store.setForRealm({ itemHeights })
      }
    }
  }
</script>
